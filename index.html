<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kalendarz salonu</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>Wizyty</h1>
  <div id="login-box">
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Hasło" />
    <button onclick="login()">Zaloguj</button>
  </div>
  <div id="app" style="display:none">
    <p>Zalogowany jako <span id="user-email"></span> <button onclick="logout()">Wyloguj</button></p>
    <input id="client" placeholder="Klient" />
    <input id="service" placeholder="Usługa" />
    <input id="date" type="datetime-local" />
    <button onclick="addAppointment()">Dodaj wizytę</button>
    <ul id="appointments"></ul>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBM4WEeOSVQgk6XRUeX0FtKUB3n0fYhXZU",
      authDomain: "salo.firebaseapp.com",
      projectId: "salo",
      storageBucket: "salo.appspot.com",
      messagingSenderId: "345207567750",
      appId: "1:345207567750:web:fc8c38b347501a2f457ea6"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    db.enableIndexedDbPersistence().catch((err) => {
      console.warn("Persistence error:", err.code);
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("login-box").style.display = "none";
        document.getElementById("app").style.display = "block";
        document.getElementById("user-email").innerText = user.email;
        loadAppointments(user.uid);
      } else {
        document.getElementById("login-box").style.display = "block";
        document.getElementById("app").style.display = "none";
      }
    });

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password).catch(error => {
        console.error("Błąd logowania:", error);
        alert("Błąd logowania: " + error.message);
      });
    }

    function logout() {
      auth.signOut();
    }

    async function addAppointment() {
      const user = auth.currentUser;
      const client = document.getElementById("client").value;
      const service = document.getElementById("service").value;
      const date = document.getElementById("date").value;

      // Logowanie wartości przed próbą zapisu
      console.log("Attempting to add appointment:");
      console.log("Current User UID:", user ? user.uid : "No user logged in");
      console.log("Client:", client);
      console.log("Service:", service);
      console.log("Date:", date);

      if (user && client && service && date) {
        try {
          await db.collection("appointments").doc(user.uid).collection("list").add({
            client,
            service,
            date
          });
          console.log("Wizyta dodana pomyślnie!");
          // Oczyść pola po dodaniu
          document.getElementById("client").value = "";
          document.getElementById("service").value = "";
          document.getElementById("date").value = "";
          loadAppointments(user.uid);
        } catch (error) {
          console.error("Błąd podczas dodawania wizyty:", error);
          alert("Wystąpił błąd podczas dodawania wizyty. Sprawdź konsolę, aby uzyskać szczegóły. Prawdopodobnie problem z regułami bezpieczeństwa Firestore.");
        }
      } else {
        alert("Wypełnij wszystkie pola (Klient, Usługa, Data)!");
        console.warn("Brak wszystkich wymaganych danych do dodania wizyty.");
      }
    }

    function loadAppointments(uid) {
      db.collection("appointments").doc(uid).collection("list")
        .orderBy("date", "desc")
        .onSnapshot(snapshot => {
          const list = document.getElementById("appointments");
          list.innerHTML = "";
          if (snapshot.empty) {
            console.log("Brak wizyt dla tego użytkownika.");
          }
          snapshot.forEach(doc => {
            const item = document.createElement("li");
            const data = doc.data();
            item.textContent = `${data.date} — ${data.client} — ${data.service}`;
            list.appendChild(item);
          });
        }, error => {
          console.error("Błąd podczas ładowania wizyt:", error);
          alert("Wystąpił błąd podczas ładowania wizyt. Sprawdź konsolę.");
        });
    }
  </script>
</body>
</html>