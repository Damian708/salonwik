<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kalendarz salonu</title>
  </head>
<body>
  <h1>Wizyty</h1>
  <div id="login-box">
    <input id="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Hasło" />
    <button onclick="login()">Zaloguj</button>
  </div>
  <div id="app" style="display:none">
    <p>Zalogowany jako <span id="user-email"></span> <button onclick="logout()">Wyloguj</button></p>
    <input id="client" placeholder="Klient" />
    <input id="service" placeholder="Usługa" />
    <input id="date" type="datetime-local" />
    <button onclick="addAppointment()">Dodaj wizytę</button>
    <ul id="appointments"></ul>
  </div>

  <script type="module">
    // Importuj moduły Firebase v9
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getFirestore, collection, doc, addDoc, onSnapshot, query, orderBy, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBM4WEeOSVQgk6XRUeX0FtKUB3n0fYhXZU",
      authDomain: "salo.firebaseapp.com",
      projectId: "salo",
      storageBucket: "salo.appspot.com",
      messagingSenderId: "345207567750",
      appId: "1:345207567750:web:fc8c38b347501a2f457ea6"
    };

    // Inicjalizacja Firebase App
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); // Pobranie instancji Auth
    const db = getFirestore(app); // Pobranie instancji Firestore

    // Dodano logi po inicjalizacji
    console.log("Firebase App initialized:", app);
    console.log("Auth instance:", auth);
    console.log("Firestore DB instance:", db);

    // Użycie enableIndexedDbPersistence z nowym API
    enableIndexedDbPersistence(db).catch((err) => {
      console.warn("Persistence error:", err.code, err); // Dodano err w logu
    });

    onAuthStateChanged(auth, user => { // Zmieniono z auth.onAuthStateChanged
      if (user) {
        document.getElementById("login-box").style.display = "none";
        document.getElementById("app").style.display = "block";
        document.getElementById("user-email").innerText = user.email;
        console.log("User logged in:", user.email, "UID:", user.uid); // Nowy log
        loadAppointments(user.uid);
      } else {
        document.getElementById("login-box").style.display = "block";
        document.getElementById("app").style.display = "none";
        console.log("User logged out or no user."); // Nowy log
      }
    });

    async function login() { // Zmieniono na async
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      console.log("Attempting to log in with:", email); // Nowy log
      try {
        await signInWithEmailAndPassword(auth, email, password); // Zmieniono z auth.signInWithEmailAndPassword
        console.log("Login successful!"); // Nowy log
      } catch (error) {
        console.error("Błąd logowania:", error);
        alert("Błąd logowania: " + error.message);
      }
    }

    async function logout() { // Zmieniono na async
      try {
        await signOut(auth); // Zmieniono z auth.signOut
        console.log("Logged out successfully!"); // Nowy log
      } catch (error) {
        console.error("Błąd wylogowania:", error);
        alert("Błąd wylogowania: " + error.message);
      }
    }

    async function addAppointment() {
      const user = auth.currentUser;
      const client = document.getElementById("client").value;
      const service = document.getElementById("service").value;
      const date = document.getElementById("date").value;

      // Rozszerzone logowanie wartości przed próbą zapisu
      console.log("--- Debugging addAppointment ---");
      console.log("Current User object:", user);
      console.log("Current User UID:", user ? user.uid : "No user logged in");
      console.log("Client value from input:", client);
      console.log("Service value from input:", service);
      console.log("Date value from input:", date);
      console.log("--- End Debugging ---");

      if (user && client && service && date) {
        try {
          // Użycie nowej składni dla Firestore (collection, doc, addDoc)
          const docRef = await addDoc(collection(doc(db, "appointments", user.uid), "list"), {
            client,
            service,
            date
          });
          console.log("Wizyta dodana pomyślnie! Document ID:", docRef.id);
          // Oczyść pola po dodaniu
          document.getElementById("client").value = "";
          document.getElementById("service").value = "";
          document.getElementById("date").value = "";
          loadAppointments(user.uid);
        } catch (error) {
          console.error("Błąd podczas dodawania wizyty:", error);
          alert("Wystąpił błąd podczas dodawania wizyty. Sprawdź konsolę, aby uzyskać szczegóły. Prawdopodobnie problem z regułami bezpieczeństwa Firestore lub konfiguracją.");
        }
      } else {
        alert("Wypełnij wszystkie pola (Klient, Usługa, Data)!");
        console.warn("Brak wszystkich wymaganych danych do dodania wizyty. Sprawdź logi powyżej.");
      }
    }

    function loadAppointments(uid) {
      // Użycie nowej składni dla Firestore (collection, doc, query, orderBy, onSnapshot)
      const q = query(collection(doc(db, "appointments", uid), "list"), orderBy("date", "desc"));
      onSnapshot(q, (snapshot) => {
        const list = document.getElementById("appointments");
        list.innerHTML = "";
        if (snapshot.empty) {
          console.log("Brak wizyt dla tego użytkownika.");
        }
        snapshot.forEach(doc => {
          const item = document.createElement("li");
          const data = doc.data();
          item.textContent = `${data.date} — ${data.client} — ${data.service}`;
          list.appendChild(item);
        });
      }, (error) => { // Obsługa błędu dla onSnapshot
        console.error("Błąd podczas ładowania wizyt:", error);
        alert("Wystąpił błąd podczas ładowania wizyt. Sprawdź konsolę.");
      });
    }
  </script>
</body>
</html>
